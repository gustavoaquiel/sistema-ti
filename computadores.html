<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Computadores - Sistema TI</title>

<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">

<style>
*{margin:0;padding:0;box-sizing:border-box;font-family:'Poppins', sans-serif;}
body{
    background: linear-gradient(135deg,#0a1f44,#123a7a,#1e90ff);
    min-height:100vh;
    color:white;
    display:flex;
    flex-direction:column;
}
header{
    display:flex;
    justify-content:space-between;
    align-items:center;
    padding:20px 40px;
    background:rgba(0,0,0,0.3);
    backdrop-filter: blur(10px);
}
header img{height:40px;}
nav a{color:white;margin-left:20px;text-decoration:none;font-weight:500;}
nav a:hover{opacity:0.7;}
.container{
    width:95%;
    max-width:1200px;
    margin:30px auto;
    flex:1;
}
.form-area{
    background:white;
    color:#333;
    padding:25px;
    border-radius:15px;
    box-shadow:0 10px 25px rgba(0,0,0,0.2);
    margin-bottom:25px;
}
.form-area input{
    padding:10px;
    border-radius:8px;
    border:1px solid #ccc;
    margin:5px;
}
.form-area button{
    background:#0a1f44;
    color:white;
    border:none;
    padding:10px 20px;
    border-radius:8px;
    cursor:pointer;
}
.form-area button:hover{background:#062a66;}
.table-area{
    background:white;
    color:#333;
    padding:20px;
    border-radius:15px;
    box-shadow:0 10px 25px rgba(0,0,0,0.2);
    overflow-x:auto;
}
table{
    width:100%;
    border-collapse:collapse;
}
th, td{
    padding:10px;
    border-bottom:1px solid #ddd;
    text-align:left;
}
th{background:#f2f2f2;}
.export-area{margin-bottom:20px;}


#modalEdicao{
    display:none;
    position:fixed;
    top:0; left:0;
    width:100%; height:100%;
    background:rgba(0,0,0,0.7);
    justify-content:center;
    align-items:center;
    z-index:1000;
}
#modalEdicao .modal-content{
    background:white;
    color:#333;
    padding:20px;
    border-radius:10px;
    width:90%;
    max-width:500px;
}
#modalEdicao .modal-content input{
    width:100%;
    margin:5px 0;
}
#modalEdicao .modal-content button{
    margin-top:10px;
}


footer.footer{
    background:rgba(0,0,0,0.3);
    backdrop-filter: blur(10px);
    text-align:center;
    padding:15px;
    font-size:14px;
}
footer.footer a{
    color:white;
    text-decoration:underline;
}
</style>
</head>

<body>

<header>
    <img src="imagens/logojbs.jfif">
    <nav>
        <a href="tarefas.html">Tarefas</a>
        <a href="computadores.html">Computadores</a>
        <a href="index.html" onclick="logout()">Sair</a>
    </nav>
</header>

<div class="container">

    <div class="form-area" id="formComputador">
        <h3>Adicionar Computador</h3>
        <input type="text" id="usuario" placeholder="Nome do Usuário">
        <input type="text" id="nomePc" placeholder="Nome do Computador">
        <input type="text" id="setor" placeholder="Setor">
        <input type="text" id="serviceTag" placeholder="Service Tag">
        <input type="text" id="patrimonio" placeholder="Patrimônio">
        <input type="text" id="office" placeholder="Office">
        <input type="text" id="obs" placeholder="Observações">
        <br><br>
        <button onclick="adicionarComputador()">Salvar</button>
    </div>

    <div class="export-area">
        <button id="btnExportar" onclick="exportExcel()">Exportar Excel</button>
    </div>

    <div class="table-area">
        <table>
            <thead>
                <tr>
                    <th>Usuário</th>
                    <th>Nome do PC</th>
                    <th>Setor</th>
                    <th>Service Tag</th>
                    <th>Patrimônio</th>
                    <th>Office</th>
                    <th>Obs</th>
                    <th>Ações</th>
                </tr>
            </thead>
            <tbody id="tabelaComputadores"></tbody>
        </table>
    </div>
</div>


<div id="modalEdicao">
    <div class="modal-content">
        <h3>Editar Computador</h3>
        <input type="text" id="editUsuario" placeholder="Nome do Usuário">
        <input type="text" id="editNomePc" placeholder="Nome do Computador">
        <input type="text" id="editSetor" placeholder="Setor">
        <input type="text" id="editServiceTag" placeholder="Service Tag">
        <input type="text" id="editPatrimonio" placeholder="Patrimônio">
        <input type="text" id="editOffice" placeholder="Office">
        <input type="text" id="editObs" placeholder="Observações">
        <button onclick="salvarEdicao()">Salvar Alterações</button>
        <button onclick="fecharModal()">Cancelar</button>
    </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
import { 
  getAuth, 
  onAuthStateChanged,
  signOut 
} from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
import { 
  getFirestore, 
  collection, 
  addDoc, 
  getDocs, 
  deleteDoc, 
  doc, 
  updateDoc, 
  query, 
  where,
  getDoc 
} from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyAdG2I9naqVe1tT2Y1dRAD-McuGaJiyTNU",
  authDomain: "sistema-ti-jbs.firebaseapp.com",
  projectId: "sistema-ti-jbs",
  storageBucket: "sistema-ti-jbs.firebasestorage.app",
  messagingSenderId: "1033258512541",
  appId: "1:1033258512541:web:1b9755d5957c7e37736474"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

let currentUser = null;
let isAdmin = false;
const ADMIN_EMAIL = "gustavo.aquiel@jbs.com.br";
let indiceEditando = null; 

onAuthStateChanged(auth, (user) => {
  if (!user) {
    window.location.href = "index.html";
    return;
  }
  
  currentUser = user;
  isAdmin = user.email === ADMIN_EMAIL;
  
  
  const form = document.getElementById("formComputador");
  const btnExportar = document.getElementById("btnExportar");
  
  if (isAdmin) {
    if (form) form.style.display = "none";
    if (btnExportar) btnExportar.style.display = "inline-block";
  } else {
    if (form) form.style.display = "block";
    if (btnExportar) btnExportar.style.display = "none";
  }
  
  renderizarComputadores();
});


async function renderizarComputadores() {
  const tabela = document.getElementById("tabelaComputadores");
  tabela.innerHTML = "";

  try {
    let consulta;
    if (isAdmin) {
      consulta = collection(db, "computadores");
    } else {
      consulta = query(
        collection(db, "computadores"),
        where("uid", "==", currentUser.uid)
      );
    }

    const snapshot = await getDocs(consulta);
    
    if (snapshot.empty) {
      tabela.innerHTML = "<tr><td colspan='8'>Nenhum computador encontrado</td></tr>";
      return;
    }

    snapshot.forEach(docSnap => {
      const data = docSnap.data();
      const id = docSnap.id;

      const row = document.createElement("tr");
      row.innerHTML = `
        <td>${data.usuario || ''}</td>
        <td>${data.nomePc || ''}</td>
        <td>${data.setor || ''}</td>
        <td>${data.serviceTag || ''}</td>
        <td>${data.patrimonio || ''}</td>
        <td>${data.office || ''}</td>
        <td>${data.obs || ''}</td>
        <td>
          ${isAdmin ? `
            <button onclick="abrirModal('${id}')">Editar</button>
            <button onclick="excluirComputador('${id}')">Excluir</button>
          ` : ""}
        </td>
      `;
      tabela.appendChild(row);
    });
  } catch (error) {
    console.error("Erro ao carregar:", error);
    tabela.innerHTML = "<tr><td colspan='8'>Erro ao carregar dados</td></tr>";
  }
}


window.adicionarComputador = async function() {
  if (isAdmin) { 
    alert("Administrador não pode cadastrar computadores."); 
    return; 
  }
  
  const usuario = document.getElementById("usuario").value;
  const nomePc = document.getElementById("nomePc").value;
  const setor = document.getElementById("setor").value;
  const serviceTag = document.getElementById("serviceTag").value;
  const patrimonio = document.getElementById("patrimonio").value;
  const office = document.getElementById("office").value;
  const obs = document.getElementById("obs").value;
  
  if(!usuario || !nomePc) { 
    alert("Preencha Usuário e Nome do PC"); 
    return; 
  }
  
  try {
    await addDoc(collection(db, "computadores"), {
      uid: currentUser.uid,
      usuario, 
      nomePc, 
      setor, 
      serviceTag, 
      patrimonio, 
      office, 
      obs,
      email: currentUser.email,
      dataCadastro: new Date().toISOString()
    });
    
    alert("Computador cadastrado com sucesso!");
    document.querySelectorAll(".form-area input").forEach(i => i.value = "");
    renderizarComputadores();
  } catch (error) {
    console.error("Erro ao cadastrar:", error);
    alert("Erro ao cadastrar computador. Tente novamente.");
  }
}


window.abrirModal = async function(id) {
  if (!isAdmin) return;
  
  try {
    const docRef = doc(db, "computadores", id);
    const docSnap = await getDoc(docRef);
    
    if (docSnap.exists()) {
      const data = docSnap.data();
      indiceEditando = id; 
      
      document.getElementById("editUsuario").value = data.usuario || '';
      document.getElementById("editNomePc").value = data.nomePc || '';
      document.getElementById("editSetor").value = data.setor || '';
      document.getElementById("editServiceTag").value = data.serviceTag || '';
      document.getElementById("editPatrimonio").value = data.patrimonio || '';
      document.getElementById("editOffice").value = data.office || '';
      document.getElementById("editObs").value = data.obs || '';
      
      document.getElementById("modalEdicao").style.display = "flex";
    }
  } catch (error) {
    console.error("Erro ao buscar dados:", error);
    alert("Erro ao carregar dados para edição");
  }
}


window.salvarEdicao = async function() {
  if (!isAdmin || !indiceEditando) return;

  try {
    const docRef = doc(db, "computadores", indiceEditando);
    
    await updateDoc(docRef, {
      usuario: document.getElementById("editUsuario").value,
      nomePc: document.getElementById("editNomePc").value,
      setor: document.getElementById("editSetor").value,
      serviceTag: document.getElementById("editServiceTag").value,
      patrimonio: document.getElementById("editPatrimonio").value,
      office: document.getElementById("editOffice").value,
      obs: document.getElementById("editObs").value
    });

    alert("Computador atualizado com sucesso!");
    fecharModal();
    renderizarComputadores();
  } catch (error) {
    console.error("Erro ao atualizar:", error);
    alert("Erro ao atualizar computador");
  }
}


window.excluirComputador = async function(id) {
  if (!isAdmin) return;
  
  if (!confirm("Deseja excluir este computador?")) return;

  try {
    await deleteDoc(doc(db, "computadores", id));
    alert("Computador excluído com sucesso!");
    renderizarComputadores();
  } catch (error) {
    console.error("Erro ao excluir:", error);
    alert("Erro ao excluir computador");
  }
}


window.exportExcel = async function() {
  if (!isAdmin) { 
    alert("Apenas administrador pode exportar."); 
    return; 
  }

  try {
    const snapshot = await getDocs(collection(db, "computadores"));
    const dados = [];
    
    snapshot.forEach(doc => {
      dados.push(doc.data());
    });

    
    let csv = "Usuário,Nome do PC,Setor,Service Tag,Patrimônio,Office,Obs\n";
    dados.forEach(c => {
      csv += `"${c.usuario}","${c.nomePc}","${c.setor}","${c.serviceTag}","${c.patrimonio}","${c.office}","${c.obs || ""}"\n`;
    });
    
    const blob = new Blob([csv], {type: "text/csv;charset=utf-8"});
    const link = document.createElement("a");
    link.href = URL.createObjectURL(blob);
    link.download = "computadores.csv";
    link.click();
  } catch (error) {
    console.error("Erro ao exportar:", error);
    alert("Erro ao exportar dados");
  }
}


window.fecharModal = function() {
  document.getElementById("modalEdicao").style.display = "none";
  indiceEditando = null;
}

window.logout = function() {
  signOut(auth).then(() => {
    window.location.href = "index.html";
  });
}


</script>

</body>
</html>
